name: Update OpenSpec Formula

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v6
      - name: Get latest GitHub release
        id: github-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="$(gh api repos/Fission-AI/OpenSpec/releases/latest -q '.tag_name')"
          VERSION="${TAG_NAME#v}"
          printf 'version=%s\n' "$VERSION" >> "$GITHUB_OUTPUT"
          printf 'Latest release: %s\n' "$VERSION"
      - name: Get npm package URL and SHA256
        id: npm-package
        run: |
          VERSION="${{ steps.github-release.outputs.version }}"
          TARBALL_URL="https://registry.npmjs.org/@fission-ai/openspec/-/openspec-${VERSION}.tgz"
          SHA256="$(curl -sL "$TARBALL_URL" | sha256sum | cut -d' ' -f1)"
          printf 'sha256=%s\n' "$SHA256" >> "$GITHUB_OUTPUT"
      - name: Update formula
        env:
          VERSION: ${{ steps.github-release.outputs.version }}
          SHA256: ${{ steps.npm-package.outputs.sha256 }}
        run: |
          sed -i "s|openspec-[0-9.]*\.tgz|openspec-${VERSION}.tgz|" Formula/openspec.rb
          sed -i "s|sha256 \"[a-f0-9]*\"|sha256 \"${SHA256}\"|" Formula/openspec.rb
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "Update openspec to ${{ steps.github-release.outputs.version }}"
          file_pattern: Formula/openspec.rb
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
