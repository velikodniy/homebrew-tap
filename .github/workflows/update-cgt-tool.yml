name: Update cgt-tool Formula

on:
  repository_dispatch:
    types:
      - cgt-tool-release
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v6
      - name: Get latest GitHub release
        id: github-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="$(gh api repos/velikodniy/cgt-tool/releases/latest -q '.tag_name')"
          VERSION="${TAG_NAME#v}"
          printf 'tag=%s\n' "$TAG_NAME" >> "$GITHUB_OUTPUT"
          printf 'version=%s\n' "$VERSION" >> "$GITHUB_OUTPUT"
          printf 'Latest release: %s\n' "$VERSION"
      - name: Download checksums
        id: checksums
        env:
          TAG: ${{ steps.github-release.outputs.tag }}
        run: |
          BASE_URL="https://github.com/velikodniy/cgt-tool/releases/download/$TAG"
          MAC_ARM_SHA256="$(curl -sL "$BASE_URL/cgt-tool-macos-aarch64.sha256")"
          MAC_INTEL_SHA256="$(curl -sL "$BASE_URL/cgt-tool-macos-x86_64.sha256")"
          LINUX_ARM_SHA256="$(curl -sL "$BASE_URL/cgt-tool-linux-aarch64.sha256")"
          LINUX_INTEL_SHA256="$(curl -sL "$BASE_URL/cgt-tool-linux-x86_64.sha256")"
          {
            echo "mac_arm=$MAC_ARM_SHA256"
            echo "mac_intel=$MAC_INTEL_SHA256"
            echo "linux_arm=$LINUX_ARM_SHA256"
            echo "linux_intel=$LINUX_INTEL_SHA256"
          } >> "$GITHUB_OUTPUT"
      - name: Update formula
        env:
          TAG: ${{ steps.github-release.outputs.tag }}
          VERSION: ${{ steps.github-release.outputs.version }}
          MAC_ARM_SHA256: ${{ steps.checksums.outputs.mac_arm }}
          MAC_INTEL_SHA256: ${{ steps.checksums.outputs.mac_intel }}
          LINUX_ARM_SHA256: ${{ steps.checksums.outputs.linux_arm }}
          LINUX_INTEL_SHA256: ${{ steps.checksums.outputs.linux_intel }}
        run: |
          sed -i "s|version \"[0-9.]*\"|version \"${VERSION}\"|" Formula/cgt-tool.rb
          sed -i "s|releases/download/v[0-9.]*/|releases/download/${TAG}/|g" Formula/cgt-tool.rb
          sed -i "/cgt-tool-macos-aarch64/{n;s|sha256 \"[a-f0-9]*\"|sha256 \"${MAC_ARM_SHA256}\"|}" Formula/cgt-tool.rb
          sed -i "/cgt-tool-macos-x86_64/{n;s|sha256 \"[a-f0-9]*\"|sha256 \"${MAC_INTEL_SHA256}\"|}" Formula/cgt-tool.rb
          sed -i "/cgt-tool-linux-aarch64/{n;s|sha256 \"[a-f0-9]*\"|sha256 \"${LINUX_ARM_SHA256}\"|}" Formula/cgt-tool.rb
          sed -i "/cgt-tool-linux-x86_64/{n;s|sha256 \"[a-f0-9]*\"|sha256 \"${LINUX_INTEL_SHA256}\"|}" Formula/cgt-tool.rb
      - name: Run tests
        uses: ./.github/workflows/tests.yml
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "Update cgt-tool to ${{ steps.github-release.outputs.tag }}"
          file_pattern: Formula/cgt-tool.rb
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
